/* MIT License - Copyright (c) Microsoft Corporation. */


!function(e,x){"use strict";var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};var a=function(){return(a=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},t=(n.merge=function(e,t){for(var r=window||global,n=0,i=e.split(".");n<i.length;n++){var o=i[n];if(!r[o])return t;r=r[o]}return a(a({},r),t)},n);function n(){}var b=(i.parse=function(e){if(!Array.isArray(e))return new u.literal(e);if(0<e.length){var t=u[e[0]];if(t)return t.parse(e)}throw"Invalid expression"},i);function i(){}var o=(s.parse=function(e){if(3<=e.length)return new s(e[0],b.parse(e[1]),b.parse(e[2]));throw"Invalid '"+e[1]+"' expression."},s.prototype.eval=function(e){var t=this._e1.eval(e),r=this._e2.eval(e);switch(this._c){case"<":return t<r;case"<=":return t<=r;case"==":return t==r;case"!=":return t!=r;case">":return r<t;case">=":return r<=t;case">":return r<t}throw"Invalid comparison"},s);function s(e,t,r){this._c=e,this._e1=t,this._e2=r}var l=(c.parse=function(e){if(3<=e.length){for(var t=[],r=1,n=e.length;r<n;r++)Array.isArray(e[1])?t.push(b.parse(e[r])):t.push(e[r]);return new c(e[0],t)}throw"Invalid '"+e[0]+"' expression."},c.prototype.eval=function(e){var t=1<=this._e.length?this._getValue(e,this._e[0]):0,r=2<=this._e.length?this._getValue(e,this._e[1]):0;switch(this._o){case"+":case"*":case"min":case"max":this._evalArray(e);break;case"-":return r-t;case"/":return t/r;case"%":return t%r;case"^":return Math.pow(t,r);case"abs":return Math.abs(t);case"acos":return Math.acos(t);case"asin":return Math.asin(t);case"atan":return Math.atan(t);case"ceil":return Math.ceil(t);case"cos":return Math.cos(t);case"e":return Math.exp(t);case"floor":return Math.floor(t);case"ln":return Math.log(t);case"ln2":return Math.LN2;case"log10":return Math.log(t)/Math.LN10;case"log2":return Math.log(t)/Math.LN2;case"pi":return Math.PI;case"round":return Math.round(t);case"sin":return Math.sin(t);case"sqrt":return Math.sqrt(t);case"tan":return Math.tan(t)}throw"Invalid '"+this._o+"' expression."},c.prototype._evalArray=function(r){var e,n=this,t=0;switch(this._o){case"+":e=function(e,t){return e+n._getValue(r,t)};break;case"*":t=1,e=function(e,t){return e*n._getValue(r,t)};break;case"max":t=this._getValue(r,this._e[0]),e=function(e,t){return Math.max(e,n._getValue(r,t))};break;case"min":t=this._getValue(r,this._e[0]),e=function(e,t){return Math.min(e,n._getValue(r,t))}}return this._e.reduce(e,t)},c.prototype._getValue=function(e,t){return"number"==typeof t?t:t.eval(e)},c);function c(e,t){this._o=e,this._e=t}var h=(p.parse=function(e){if(3<=e.length)return new p(e[0],b.parse(e[2]),e[1]);if(2===e.length)return new p(e[0],b.parse(e[1]));throw"Invalid 'CellAggregateExpression'."},p.prototype.eval=function(e){return this._e.eval(e)},p.prototype.finalize=function(e,t){if(e.aggregateProperties){var r=e.aggregateProperties[t],n=this._i;if(void 0!==n)switch(this._o){case"max":r=Math.max(n,r);break;case"min":r=Math.min(n,r);break;case"+":r=n+r;break;case"*":r*=n;break;case"all":r=n&&r;break;case"any":r=n||r}e.aggregateProperties[t]=r}},p);function p(e,t,r){this._o=e,this._e=t,this._i=r}var u={get:(S.parse=function(e){var t=3<=e.length?b.parse(e[2]):void 0;if(2<=e.length)return new S(e[1],t);throw"Invalid 'get' expression."},S.prototype.eval=function(e){var t=e;return this._e&&(t=this._e.eval(e)),t[this._n]},S),has:(T.parse=function(e){var t=3<=e.length?b.parse(e[2]):void 0;if(2<=e.length)return new T(e[1],t);throw"Invalid 'has' expression."},T.prototype.eval=function(e){var t=e;return this._e&&(t=this._e.eval(e)[this._n]),-1<Object.keys(t).indexOf(this._n)},T),literal:(A.parse=function(e){if(2<=e.length)return new A(e[1]);throw"Invalid 'literal' expression."},A.prototype.eval=function(e){return this._v},A),at:(z.parse=function(e){if(3<=e.length)return new z(e[1],b.parse(e[2]));throw"Invalid 'at' expression."},z.prototype.eval=function(e){return this._e.eval(e)[this._i]},z),"index-of":(O.parse=function(e){var t=0;if(4<=e.length&&(t=e[3]),3<=e.length)return new O(e[1],b.parse(e[2]),t);throw"Invalid 'index-of' expression."},O.prototype.eval=function(e){return this._e.eval(e).indexOf(this._v,this._i)},O),length:(k.parse=function(e){if(3<=e.length)return new k(b.parse(e[1]));throw"Invalid 'length' expression."},k.prototype.eval=function(e){return this._e.eval(e).length},k),slice:(I.parse=function(e){var t;if(4<=e.length&&(t=e[3]),3<=e.length)return new I(b.parse(e[1]),e[2],t);throw"Invalid 'index-of' expression."},I.prototype.eval=function(e){return this._v.eval(e).slice(this._s,this._e)},I),"!":(C.parse=function(e){if(2<=e.length)return new C(b.parse(e[1]));throw"Invalid '!' expression."},C.prototype.eval=function(e){return!this._e.eval(e)},C),"!=":o,"<":o,"<=":o,"==":o,">":o,">=":o,"to-boolean":(P.parse=function(e){if(2<=e.length)return new P(b.parse(e[1]));throw"Invalid 'to-boolean' expression."},P.prototype.eval=function(e){var t=this._e.eval(e);return"boolean"==typeof t?t:"string"==typeof t?-1<["true","yes","on","1"].indexOf(t.toLowerCase()):"number"==typeof t&&1===t},P),"to-number":(M.parse=function(e){if(2<=e.length)return new M(b.parse(e[1]));throw"Invalid 'to-number' expression."},M.prototype.eval=function(e){var t=this._e.eval(e);return"boolean"==typeof t?t?1:0:"string"==typeof t?Number.parseFloat(t):"number"==typeof t?t:Number.NaN},M),"to-string":(w.parse=function(e){if(2<=e.length)return new w(b.parse(e[1]));throw"Invalid 'to-number' expression."},w.prototype.eval=function(e){var t=this._e.eval(e);return t.toString?t.toString():Number.NaN},w),typeof:(m.parse=function(e){if(2<=e.length)return new m(b.parse(e[1]));throw"Invalid 'typeOf' expression."},m.prototype.eval=function(e){return typeof this._e.eval(e)},m),case:(y.parse=function(e){if(3<=e.length&&e.length%2==0){for(var t=[],r=[],n=1,i=e.length;n<i;n+=2)t.push(b.parse(e[n])),r.push(e[n+1]);return new y(t,r,e[e.length-1])}throw"Invalid 'case' expression."},y.prototype.eval=function(e){for(var t=0,r=this._e.length;t<r;t++)if(this._e[t].eval(e))return this._o[t];return this._f},y),match:(v.parse=function(e){if(5<=e.length&&e.length%2==1){for(var t=b.parse(e[1]),r=[],n=[],i=2,o=e.length;i<o;i+=2)r.push(e[i]),n.push(e[i+1]);return new v(t,r,n,e[e.length-1])}throw"Invalid 'match' expression."},v.prototype.eval=function(e){for(var t=this._i.eval(e),r=0,n=this._l.length;r<n;r++)if(this._l[r]===t)return this._o[r];return this._f},v),step:(d.parse=function(e){if(5<=e.length&&e.length%2==1){for(var t=b.parse(e[1]),r=[],n=[],i=2,o=e.length;i<o;i+=2)r.push(e[i]),n.push(e[i+1]);return new d(t,r,n,e[e.length-1])}throw"Invalid 'step' expression."},d.prototype.eval=function(e){for(var t=this._i.eval(e),r=0,n=this._l.length;r<n;r++)if(t<=this._l[r])return this._o[r];return this._o[this._o.length-1]},d),in:(g.parse=function(e){if(3<=e.length)return new g(e[1],b.parse(e[2]));throw"Invalid 'at' expression."},g.prototype.eval=function(e){return-1<this._e.eval(e).indexOf(this._i)},g),all:(_.parse=function(e){if(3<=e.length&&e.length%2==0){for(var t=[],r=1,n=e.length;r<n;r++)t.push(b.parse(e[r]));return new _(t)}throw"Invalid 'all' expression."},_.prototype.eval=function(t){var r=!0;return this._e.forEach(function(e){r=r&&e.eval(t)}),r},_),any:(f.parse=function(e){if(3<=e.length&&e.length%2==0){for(var t=[],r=1,n=e.length;r<n;r++)t.push(b.parse(e[r]));return new f(t)}throw"Invalid 'any' expression."},f.prototype.eval=function(t){var r=!1;return this._e.forEach(function(e){r=r||e.eval(t)}),r},f),"+":l,"*":l,min:l,max:l,"-":l,"/":l,"%":l,"^":l,abs:l,acos:l,asin:l,atan:l,ceil:l,cos:l,e:l,floor:l,ln:l,ln2:l,log10:l,log2:l,pi:l,round:l,sin:l,sqrt:l,tan:l};function f(e){this._e=e}function _(e){this._e=e}function g(e,t){this._i=e,this._e=t}function d(e,t,r,n){this._i=e,this._l=t,this._o=r,this._f=n}function v(e,t,r,n){this._i=e,this._l=t,this._o=r,this._f=n}function y(e,t,r){this._e=e,this._o=t,this._f=r}function m(e){this._e=e}function w(e){this._e=e}function M(e){this._e=e}function P(e){this._e=e}function C(e){this._e=e}function I(e,t,r){this._v=e,this._s=t,this._e=r}function k(e){this._e=e}function O(e,t,r){this._v=e,this._e=t,this._i=r}function z(e,t){this._i=e,this._e=t}function A(e){this._v=e}function T(e,t){this._n=e,this._e=t}function S(e,t){this._n=e,this._e=t}var L=(E.calculateGrid=function(e,t,r){var n=this;r=Object.assign({gridType:"hexagon",cellWidth:25e3,distanceUnits:"meters",coverage:1,minCellWidth:0,scaleExpression:n.LinearPointCountScaleExpression},r||{}),e=e||[];var i,o=n._getGroundResolutionZ22(r.centerLatitude),a=x.math.convertDistance(r.cellWidth,r.distanceUnits,"meters")/o,s=x.math.convertDistance(Math.min(r.minCellWidth,r.cellWidth),r.distanceUnits,"meters")/o,l=r.aggregateProperties&&0<Object.keys(r.aggregateProperties).length,c=l?n._parseMapExpressions(r.aggregateProperties):{},h=b.parse(r.scaleExpression||n.LinearPointCountScaleExpression),p=n._getArcAngles(r.gridType),u=Math.sqrt(3);switch(r.gridType){case"pointyHexagon":i=2*a/u;break;case"hexagon":case"hexCircle":i=u*a*.5;break;case"triangle":i=.5*u*a;break;default:i=a}for(var f={cells:[],cellLookupTable:{},pointLookupTable:{},width:a,height:i},_={col:0,row:0,z:0},g=0,d=e.length;g<d;g++){var v=t[g];n._getCellCoord(v,a,i,r.gridType,_,u);var y="x"+_.col+"y"+_.row+"z"+_.z,m=n._getGridCell(y,_,g,f,a,i,r.gridType,l);n._incrementCellInfo(m.properties,e[g],r.aggregateProperties,c)}return n._finalizeGrid(f,a,i,r,c,h,s,p),f},E.recalculateCoords=function(e,t){for(var r=b.parse(t.scaleExpression||this.LinearPointCountScaleExpression),n=x.math.convertDistance(Math.min(t.minCellWidth,t.cellWidth),t.distanceUnits,"meters")/this._getGroundResolutionZ22(t.centerLatitude),i=0,o=e.cells.length;i<o;i++)e.cells[i].geometry.coordinates=this.createGridPolygon(e.cells[i].properties,t,e.width,e.height,this._getArcAngles(t.gridType),n,r,e.scaleMetrics)},E.toPixel22=function(e){var t=Math.sin(e[1]*this.PI_By_180),r=this.MapSize22;return[(e[0]+180)/360*r,(.5-Math.log((1+t)/(1-t))/(4*Math.PI))*r]},E._getCellCoord=function(e,t,r,n,i,o){switch(n){case"pointyHexagon":this._rotatedHexCellCoord(e,t,r,i,o);break;case"hexagon":case"hexCircle":this._hexCellCoord(e,t,r,i,o);break;case"triangle":this._triangleCellCoord(e,t,r,i,o);break;default:i.col=Math.floor(e[0]/t),i.row=Math.floor(e[1]/r)}},E._getGroundResolutionZ22=function(e){return 2*Math.cos(e*this.PI_By_180)*Math.PI*6378137/this.MapSize22},E._getGridCell=function(e,t,r,n,i,o,a,s){var l=n.cellLookupTable[e];if(void 0!==l)return n.pointLookupTable[e].push(r),n.cells[l];var c=this._createCellFromCubeCoord(e,t,a,i,o,s);return n.pointLookupTable[e]=[r],n.cells.push(c),n.cellLookupTable[e]=n.cells.length-1,c},E._hexCellCoord=function(e,t,r,n,i){n.col=4*e[0]/(3*t),n.z=(e[1]-e[0]/i)/r,n.row=-n.col-n.z,E._roundCubeCoord(n)},E._rotatedHexCellCoord=function(e,t,r,n,i){return n.col=(e[0]-e[1]/i)/t,n.z=4*e[1]/(3*r),n.row=-n.col-n.z,E._roundCubeCoord(n)},E._roundCubeCoord=function(e){var t=Math.round(e.col),r=Math.round(e.row),n=Math.round(e.z),i=Math.abs(t-e.col),o=Math.abs(r-e.row),a=Math.abs(n-e.z);o<i&&a<i?t=-r-n:a<o?r=-t-n:n=-t-r,e.col=t,e.row=r,e.z=n},E._triangleCellCoord=function(e,t,r,n,i){n.row=Math.floor(e[1]/r),n.col=Math.floor(e[0]/t);var o=(n.row+1)*r-e[1],a=e[0]-n.col*t;n.row%2==1&&(o=r-o),1<o&&(a<.5*t?a/o<1/i&&(n.col-=.5):(t-a)/o<1/i&&(n.col+=.5))},E._createCellFromCubeCoord=function(e,t,r,n,i,o){var a,s,l;switch(r){case"pointyHexagon":a=n*(t.col+.5*t.z),s=.75*i*t.z;break;case"hexagon":case"hexCircle":a=.75*n*t.col,s=i*(t.z+.5*t.col);break;case"triangle":s=Math.floor(t.row*i),a=Math.floor((t.col+.5)*n);var c=Math.abs(t.col-Math.round(t.col))<.1;l=Math.round(t.row)%2==0?c:!c;break;default:a=(t.col+.5)*n,s=(t.row+.5)*i}return this._createCell(e,a,s,l,o)},E._getArcAngles=function(e){var t=E._arcAngles[e];if(!t){switch(e){case"circle":case"hexCircle":t=this._calculateArcAngles(36);break;case"pointyHexagon":t=this._calculateArcAngles(6);break;case"hexagon":t=this._calculateArcAngles(6,30)}E._arcAngles[e]=t}return t},E._calculateArcAngles=function(e,t){t=t||0;for(var r,n=360/e,i=[],o=[],a=0;a<e;a++)r=(a*n+t)*this.PI_By_180,i.push(Math.sin(r)),o.push(Math.cos(r));return{sin:i,cos:o}},E._toPosition22=function(e){var t=this.MapSize22;return[360*(e[0]/t-.5),90-360*Math.atan(Math.exp((e[1]/t-.5)*Math.PI*2))/Math.PI]},E._parseMapExpressions=function(r){var e,n={};return r&&Object.keys(r).forEach(function(t){if((e=r[t])&&2<=e.length)try{n[t]=h.parse(e)}catch(e){r[t]=void 0}else r[t]=void 0}),n},E._incrementCellInfo=function(n,i,o,a){if(n.point_count++,o){var s,l,c=n.point_count,h=n.aggregateProperties||{};Object.keys(o).forEach(function(e){var t=o[e],r=a[e];if(r){if(l=r.eval(i.properties),null!==(s=1===c?Array.isArray(t[1])?null:t[1]:h[e]))switch(t[0]){case"max":l=l<s?s:l;break;case"min":l=s<l?s:l;break;case"+":l=s+l;break;case"*":l*=s;break;case"all":l=s&&l;break;case"any":l=s||l}null!==l&&(h[e]=l)}n.aggregateProperties=h})}},E._finalizeCellInfo=function(t,r,e,n){var i=t.point_count,o=i.toString();1e6<=i?o=Math.round(i/1e6)+"M":1e3<=i&&(o=Math.round(i/1e3)+"k"),t.point_count_abbreviated=o;var a=i;r&&(Object.keys(r).forEach(function(e){r[e].finalize(t,e)}),n&&void 0!==t.aggregateProperties[n]&&(a=t.aggregateProperties[n])),e&&(void 0===e.min?(e.min=a,e.max=a):(e.min=Math.min(e.min,a),e.max=Math.max(e.max,a)))},E._createCell=function(e,t,r,n,i){return{type:"Feature",properties:{cell_id:e,aggregateProperties:i?{}:void 0,_x:t,_y:r,_rightSideUp:n,point_count:0,point_count_abbreviated:"0"},geometry:{type:"Polygon",coordinates:[]}}},E.createGridPolygon=function(e,t,r,n,i,o,a,s){var l=t.coverage||1;if(t.scaleProperty&&s){var c=a.eval(Object.assign({min:s.min,max:s.max},e));isNaN(c)||"number"!=typeof c||(l*=c)}switch(t.gridType){case"square":return this._getSquare(e,r,l,o);case"hexCircle":return this._getRegularPolygon(e,this.InnerRadiusScale*r*.5*l,i,o);case"triangle":return this._getTriangle(e,r,n,l,o);case"pointyHexagon":return this._getRegularPolygon(e,.5*n*l,i,o);default:return this._getRegularPolygon(e,.5*r*l,i,o)}},E._getRegularPolygon=function(r,n,i,e){var o,a,s=this,l=[],c=s.MapSize22;return 2*n<e&&(n=.5*e),i.sin.forEach(function(e,t){o=Math.min(Math.max(r._x+n*e,0),c),a=r._y+n*i.cos[t],l.push(s._toPosition22([o,a]))}),l.push(l[0]),[l]},E._getSquare=function(e,t,r,n){var i=this,o=.5*Math.max(t*r,n),a=e._y-o,s=e._y+o,l=Math.max(e._x-o,0),c=Math.min(e._x+o,i.MapSize22),h=[i._toPosition22([l,a]),i._toPosition22([l,s]),i._toPosition22([c,s]),i._toPosition22([c,a])];return h.push(h[0]),[h]},E._getTriangle=function(e,t,r,n,i){var o,a=this,s=e._x,l=e._y+.5*(r-r*n);r*=n,(t*=n)<i&&(r*=i/t);var c=.5*t,h=a.MapSize22,p=s,u=s+c,f=s-c;return f<0?(p=Math.max(p,0),u=Math.max(u,0),f=Math.max(f,0)):h<u&&(p=Math.min(p,h),u=Math.min(u,h),f=Math.min(f,h)),(o=e._rightSideUp?[a._toPosition22([p,l]),a._toPosition22([u,r+l]),a._toPosition22([f,r+l])]:[a._toPosition22([p,r+l]),a._toPosition22([u,l]),a._toPosition22([f,l])]).push(o[0]),[o]},E._finalizeGrid=function(e,t,r,n,i,o,a,s){var l={},c=e.cells.length;if(n.scaleProperty){for(var h=0;h<c;h++)this._finalizeCellInfo(e.cells[h].properties,i,l,n.scaleProperty);for(h=0;h<c;h++)e.cells[h].geometry.coordinates=E.createGridPolygon(e.cells[h].properties,n,t,r,s,a,o,l)}else for(h=0;h<c;h++)this._finalizeCellInfo(e.cells[h].properties,i,l,n.scaleProperty),e.cells[h].geometry.coordinates=E.createGridPolygon(e.cells[h].properties,n,t,r,s,a,o,l);e.scaleMetrics=l},E.PI_By_180=Math.PI/180,E.MapSize22=512*Math.pow(2,22),E.InnerRadiusScale=Math.cos(30*Math.PI/180),E.LinearPointCountScaleExpression=["/",["-",["get","point_count"],["get","min"]],["-",["get","max"],["get","min"]]],E._arcAngles={},E);function E(){}var G,W,j,N=(G=x.source.DataSource,r(W=q,j=G),W.prototype=null===j?Object.create(j):(U.prototype=j.prototype,new U),q.prototype.add=function(e){this._addPoints(e),this._recalculate()},q.prototype.clear=function(){this._points=[],this._pixels=[],G.prototype.clear.call(this)},q.prototype.dispose=function(){var t=this;this.clear(),G.prototype.dispose.call(this),Object.keys(this).forEach(function(e){return t[e]=null})},q.prototype.getCellChildren=function(e){var t=this._gridInfo.pointLookupTable[e],r=[];if(t)for(var n=0,i=t.length;n<i;n++)r.push(this._points[t[n]]);return JSON.parse(JSON.stringify(r))},q.prototype.getGridCells=function(){return G.prototype.toJson.call(this)},q.prototype.getOptions=function(){return Object.assign({},this._options)},q.prototype.getPoints=function(){return new x.data.FeatureCollection(JSON.parse(JSON.stringify(this._points)))},q.prototype.importDataFromUrl=function(r){var n=this,i=this;return new Promise(function(e,t){G.prototype.clear.call(n),G.prototype.importDataFromUrl.call(n,r).then(function(){i._addPoints(G.prototype.toJson.call(n)),i._recalculate(),e()},function(){t()})})},q.prototype.remove=function(e){this._remove(e),this._recalculate()},q.prototype.removeById=function(e){this._remove(e),this._recalculate()},q.prototype.setOptions=function(e){if(e){var t=this._options,r={},n=!1,i=!1;if("number"==typeof e.maxZoom&&0<=e.maxZoom&&e.maxZoom<25&&e.maxZoom!==t.maxZoom&&(t.maxZoom=e.maxZoom,r.maxZoom=e.maxZoom),"number"==typeof e.cellWidth&&0<e.cellWidth&&e.cellWidth!==t.cellWidth&&(t.cellWidth=e.cellWidth,i=!0),"number"==typeof e.minCellWidth&&0<=e.minCellWidth&&e.minCellWidth!==t.minCellWidth&&(t.minCellWidth=e.minCellWidth,n=!0),void 0!==e.centerLatitude&&e.centerLatitude!==t.centerLatitude&&(t.centerLatitude=e.centerLatitude,i=!0),e.distanceUnits&&e.distanceUnits!==t.distanceUnits&&(t.distanceUnits=e.distanceUnits,i=!0),e.gridType&&e.gridType!==t.gridType){var o=["square","circle"],a=["hexagon","hexCircle"];-1<a.indexOf(t.gridType)&&-1<a.indexOf(e.gridType)||-1<o.indexOf(t.gridType)&&-1<o.indexOf(e.gridType)?n=!0:i=!0,t.gridType=e.gridType}void 0!==e.aggregateProperties&&(t.aggregateProperties=e.aggregateProperties,i=!0),void 0!==e.scaleExpression&&e.scaleExpression!==t.scaleExpression&&(t.scaleExpression=e.scaleExpression,(e.scaleProperty||t.scaleProperty)&&(n=!0)),void 0!==e.scaleProperty&&e.scaleProperty!==t.scaleProperty&&(t.scaleProperty=e.scaleProperty,null===e.scaleProperty||"point_count"===e.scaleProperty?n=!0:i=!0),void 0!==e.coverage&&e.coverage!==t.coverage&&(t.coverage=e.coverage,n=!0),0<Object.keys(r).length&&G.prototype.setOptions.call(this,r),i||!this._gridInfo?this._recalculate():n&&this._recalculateCoords()}},q.prototype.setPoints=function(e){this._points=[],this._pixels=[],this._addPoints(e),this._recalculate()},q.prototype._addPoints=function(e){var t=this;if("FeatureCollection"===e.type&&(e=e.features),Array.isArray(e))for(var r=0,n=e.length;r<n;r++)t._addPoints(e[r]);else if(e instanceof x.Shape)"Point"===e.getType()&&(t._pixels.push(t._normalizeGetPixel22(e.getCoordinates())),t._points.push(e.toJson()));else if("Feature"===e.type&&"Point"===e.geometry.type){var i=e;t._pixels.push(t._normalizeGetPixel22(i.geometry.coordinates)),t._points.push(i)}else if("Point"===e.type){var o=e;t._pixels.push(t._normalizeGetPixel22(o.coordinates)),t._points.push(new x.data.Feature(o))}},q.prototype._normalizeGetPixel22=function(e){return e[0]=x.math.normalizeLongitude(e[0]),e[1]=x.math.normalizeLatitude(e[1]),L.toPixel22(e)},q.prototype._remove=function(e){var t=this;if(Array.isArray(e))for(var r=0,n=e.length;r<n;r++)t._remove(e[r]);else if(e instanceof x.Shape){var i=e.getId();for(r=0,n=t._points.length;r<n;r++)if(t._points[r].id===i){t._remove(r);break}}else if("number"==typeof e)e<t._points.length&&(t._points.splice(e,1),t._pixels.splice(e,1));else if("string"==typeof e){for(r=0,n=t._points.length;r<n;r++)if(t._points[r].id===e){t._remove(r);break}}else if("Feature"===e.type){var o=t._points.indexOf(e);t._remove(o)}},q.prototype._recalculate=function(){var e=this;void 0===this._requestId&&(e._requestId=requestAnimationFrame(function(){e._gridInfo=L.calculateGrid(e._points,e._pixels,e._options),e._updateCells(),e._requestId=void 0}))},q.prototype._recalculateCoords=function(){L.recalculateCoords(this._gridInfo,this._options),this._updateCells()},q.prototype._updateCells=function(){G.prototype._clearNoUpdate.call(this),G.prototype.add.call(this,this._gridInfo.cells)},q);function U(){this.constructor=W}function q(e,t){var r=G.call(this,e)||this;return r._options={maxZoom:18,cellWidth:25e3,minCellWidth:0,distanceUnits:"meters",gridType:"hexagon",coverage:1,centerLatitude:0},r._points=[],r._pixels=[],t&&(Object.assign(r._options,t),G.prototype.setOptions.call(r,Object.assign({buffer:8,tolerance:0},t))),r}var Z,F=Object.freeze({__proto__:null,GriddedDataSource:N});(Z=e.GridType||(e.GridType={})).circle="circle",Z.hexagon="hexagon",Z.hexCircle="hexCircle",Z.pointyHexagon="pointyHexagon",Z.square="square",Z.triangle="triangle";var H=t.merge("atlas.source",F);e.source=H}(this.atlas=this.atlas||{},atlas);
